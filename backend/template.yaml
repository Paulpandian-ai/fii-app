AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: FII - Factor Impact Intelligence Backend

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
  ClaudeApiKeyArn:
    Type: String
    Description: ARN of the Secrets Manager secret for Claude API key
  FredApiKeyArn:
    Type: String
    Description: ARN of the Secrets Manager secret for FRED API key
  FinnhubApiKeyArn:
    Type: String
    Description: ARN of the Secrets Manager secret for Finnhub API key
    Default: ''
  GoogleClientId:
    Type: String
    Description: Google OAuth Client ID for Cognito
  GoogleClientSecret:
    Type: String
    Description: Google OAuth Client Secret for Cognito
    NoEcho: true
  AppleTeamId:
    Type: String
    Description: Apple Developer Team ID
    Default: ''
  AppleKeyId:
    Type: String
    Description: Apple Sign-In Key ID
    Default: ''
  ApplePrivateKey:
    Type: String
    Description: Apple Sign-In Private Key
    NoEcho: true
    Default: ''
  ExistingTableName:
    Type: String
    Default: 'fii-table'
    Description: Name of existing DynamoDB table (leave empty to create new)
  ExistingBucketName:
    Type: String
    Default: 'fii-data-dev'
    Description: Name of existing S3 bucket (leave empty to create new)

Globals:
  Function:
    Runtime: python3.12
    MemorySize: 1024
    Timeout: 120
    Environment:
      Variables:
        STAGE: !Ref Stage
        TABLE_NAME: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        BUCKET_NAME: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]
        CLAUDE_API_KEY_ARN: !Ref ClaudeApiKeyArn
        FRED_API_KEY_ARN: !Ref FredApiKeyArn
        FINNHUB_API_KEY_ARN: !Ref FinnhubApiKeyArn
    Layers:
      - !Ref SharedLayer

Resources:
  # ─── Cognito ───

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub fii-user-pool-${Stage}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: false
        - Name: name
          Required: false
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  GoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ProviderName: Google
      ProviderType: Google
      ProviderDetails:
        client_id: !Ref GoogleClientId
        client_secret: !Ref GoogleClientSecret
        authorize_scopes: openid profile email
      AttributeMapping:
        email: email
        name: name
        username: sub

  AppleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Condition: HasAppleConfig
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ProviderName: SignInWithApple
      ProviderType: SignInWithApple
      ProviderDetails:
        client_id: !Sub com.fii.app
        team_id: !Ref AppleTeamId
        key_id: !Ref AppleKeyId
        private_key: !Ref ApplePrivateKey
        authorize_scopes: email name
      AttributeMapping:
        email: email
        name: name
        username: sub

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    DependsOn:
      - GoogleIdentityProvider
    Properties:
      ClientName: !Sub fii-app-client-${Stage}
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      SupportedIdentityProviders:
        - Google
        - COGNITO
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - openid
        - profile
        - email
      AllowedOAuthFlowsUserPoolClient: true
      CallbackURLs:
        - fii://callback
        - exp://127.0.0.1:8081/--/callback
      LogoutURLs:
        - fii://signout
      PreventUserExistenceErrors: ENABLED

  CognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref CognitoUserPool
      Domain: !Sub fii-auth-${Stage}

  # ─── API Gateway ───

  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref Stage
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowHeaders:
          - Authorization
          - Content-Type
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            AuthorizationScopes:
              - openid
            IdentitySource: $request.header.Authorization
            JwtConfiguration:
              issuer: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
              audience:
                - !Ref CognitoUserPoolClient

  # ─── DynamoDB ───

  FiiTable:
    Type: AWS::DynamoDB::Table
    Condition: CreateTable
    Properties:
      TableName: !Sub fii-table-${Stage}
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # ─── S3 ───

  FiiDataBucket:
    Type: AWS::S3::Bucket
    Condition: CreateBucket
    Properties:
      BucketName: !Sub fii-data-${Stage}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ─── Shared Lambda Layer ───

  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub fii-shared-${Stage}
      Description: >-
        Shared dependencies (anthropic, fredapi, pydantic, numpy, pandas)
        and Python modules. Uses Finnhub API (via urllib) for market data.
      ContentUri: shared_layer/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: makefile
      BuildArchitecture: x86_64

  # ─── Lambda Functions ───

  ApiHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-api-handler-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/api_handler/
      Description: Main API router for FII
      Events:
        # Public read-only endpoints (no auth required)
        GetFeed:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /feed
            Method: GET
            Auth:
              Authorizer: NONE
        GetSignal:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /signals/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetSignalsBatch:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /signals/batch
            Method: GET
            Auth:
              Authorizer: NONE
        GetPrice:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /price/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetPrices:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /prices/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetTechnicals:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /technicals/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetFundamentals:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /fundamentals/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetFactors:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /factors/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetAltData:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /altdata/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetCharts:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /charts/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetScreener:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /screener
            Method: GET
            Auth:
              Authorizer: NONE
        GetScreenerTemplates:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /screener/templates
            Method: GET
            Auth:
              Authorizer: NONE
        GetSearch:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /search
            Method: GET
            Auth:
              Authorizer: NONE
        GetBaskets:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /baskets
            Method: GET
            Auth:
              Authorizer: NONE
        GetBasketDetail:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /baskets/{id}
            Method: GET
            Auth:
              Authorizer: NONE
        GetTrending:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /trending
            Method: GET
            Auth:
              Authorizer: NONE
        GetDiscovery:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /discovery
            Method: GET
            Auth:
              Authorizer: NONE
        # Portfolio endpoints (public for dev — no login yet)
        GetPortfolio:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /portfolio
            Method: GET
            Auth:
              Authorizer: NONE
        PostPortfolio:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /portfolio
            Method: POST
            Auth:
              Authorizer: NONE
        GetPortfolioHealth:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /portfolio/health
            Method: GET
            Auth:
              Authorizer: NONE
        GetPortfolioSummary:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /portfolio/summary
            Method: GET
            Auth:
              Authorizer: NONE
        PostPortfolioCsv:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /portfolio/parse-csv
            Method: POST
            Auth:
              Authorizer: NONE
        # Watchlist endpoints (public for dev)
        GetWatchlist:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /watchlist
            Method: GET
            Auth:
              Authorizer: NONE
        PostWatchlist:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /watchlist
            Method: POST
            Auth:
              Authorizer: NONE
        PostWatchlistAdd:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /watchlist/add
            Method: POST
            Auth:
              Authorizer: NONE
        PostWatchlistRemove:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /watchlist/remove
            Method: POST
            Auth:
              Authorizer: NONE
        DeleteWatchlist:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /watchlist/{name}
            Method: DELETE
            Auth:
              Authorizer: NONE
        # Signal write endpoints (public for dev)
        PostSignalGenerate:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /signals/generate/{ticker}
            Method: POST
            Auth:
              Authorizer: NONE
        PostSignalRefresh:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /signals/refresh-all
            Method: POST
            Auth:
              Authorizer: NONE
        # Strategy endpoints (public for dev)
        PostStrategyOptimize:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/optimize
            Method: POST
            Auth:
              Authorizer: NONE
        PostStrategyProject:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/project
            Method: POST
            Auth:
              Authorizer: NONE
        PostStrategyScenarios:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/scenarios
            Method: POST
            Auth:
              Authorizer: NONE
        PostStrategyRebalance:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/rebalance
            Method: POST
            Auth:
              Authorizer: NONE
        GetStrategyAchievements:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/achievements
            Method: GET
            Auth:
              Authorizer: NONE
        PostStrategyTaxHarvest:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/tax-harvest
            Method: POST
            Auth:
              Authorizer: NONE
        PostStrategyDiversification:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/diversification
            Method: POST
            Auth:
              Authorizer: NONE
        GetStrategyCorrelation:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/correlation
            Method: GET
            Auth:
              Authorizer: NONE
        PostStrategyAdvice:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/advice
            Method: POST
            Auth:
              Authorizer: NONE
        PostStrategyBacktest:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/backtest
            Method: POST
            Auth:
              Authorizer: NONE
        GetStrategyReportCard:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/report-card
            Method: GET
            Auth:
              Authorizer: NONE
        # Coach endpoints (public for dev)
        GetCoachDaily:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/daily
            Method: GET
            Auth:
              Authorizer: NONE
        GetCoachScore:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/score
            Method: GET
            Auth:
              Authorizer: NONE
        GetCoachAchievements:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/achievements
            Method: GET
            Auth:
              Authorizer: NONE
        PostCoachEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/event
            Method: POST
            Auth:
              Authorizer: NONE
        GetCoachWeekly:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/weekly
            Method: GET
            Auth:
              Authorizer: NONE
        GetCoachInsights:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /coach/insights
            Method: GET
            Auth:
              Authorizer: NONE
        # Catch-all for any remaining routes
        CatchAll:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - S3CrudPolicy:
            BucketName: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref ClaudeApiKeyArn
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:fii/*

  # ─── Event Handler Function (event/notification API routes) ───

  EventHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-event-handler-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/event_handler/
      Description: Event timeline, alerts, and notification preference routes
      Events:
        GetEventsTicker:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /events/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetEventsFeed:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /events/feed
            Method: GET
            Auth:
              Authorizer: NONE
        GetSignalHistory:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /events/signal-history/{ticker}
            Method: GET
            Auth:
              Authorizer: NONE
        GetAlerts:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /alerts
            Method: GET
            Auth:
              Authorizer: NONE
        GetNotificationPrefs:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /notifications/preferences
            Method: GET
            Auth:
              Authorizer: NONE
        PostNotificationPrefs:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /notifications/preferences
            Method: POST
            Auth:
              Authorizer: NONE
        PostNotificationRegister:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /notifications/register
            Method: POST
            Auth:
              Authorizer: NONE
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref ClaudeApiKeyArn
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:fii/*

  # ─── SNS Topic for Push Notifications ───

  EventAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub fii-event-alerts-${Stage}
      DisplayName: FII Event Alerts

  # ─── Event Engine Lambda Functions ───

  NewsMonitorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-news-monitor-${Stage}
      Handler: event_engine.news_monitor_handler
      CodeUri: functions/api_handler/
      Description: Monitors company news via Finnhub every 15 min during market hours
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref EventAlertsTopic
      Events:
        NewsMonitorSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 14-23 ? * MON-FRI *)
            Description: Monitor news every 15 min during market hours (9AM-6PM ET)
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref ClaudeApiKeyArn
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:fii/*
        - Statement:
            - Effect: Allow
              Action: sns:Publish
              Resource: !Ref EventAlertsTopic

  SecFilingMonitorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-sec-monitor-${Stage}
      Handler: event_engine.sec_monitor_handler
      CodeUri: functions/api_handler/
      Description: Monitors SEC filings (8-K, Form 4, SC 13D/G) every 5 min during market hours
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref EventAlertsTopic
      Events:
        SecMonitorSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0/5 14-23 ? * MON-FRI *)
            Description: Monitor SEC filings every 5 min during market hours
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref ClaudeApiKeyArn
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:fii/*
        - Statement:
            - Effect: Allow
              Action: sns:Publish
              Resource: !Ref EventAlertsTopic

  MacroMonitorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-macro-monitor-${Stage}
      Handler: event_engine.macro_monitor_handler
      CodeUri: functions/api_handler/
      Description: Monitors macro economic releases and computes surprise scores
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref EventAlertsTopic
      Events:
        MacroMonitorSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 13-22 ? * MON-FRI *)
            Description: Monitor macro events every 15 min during market hours
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref FredApiKeyArn
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:fii/*
        - Statement:
            - Effect: Allow
              Action: sns:Publish
              Resource: !Ref EventAlertsTopic

  SignalEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-signal-engine-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/signal_engine/
      Description: FII 6-factor signal analysis engine
      Timeout: 900
      MemorySize: 2048
      Events:
        DailySignalRun:
          Type: Schedule
          Properties:
            Schedule: cron(0 11 ? * MON-FRI *)
            Description: Run signal engine at 6AM ET weekdays
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - S3CrudPolicy:
            BucketName: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref ClaudeApiKeyArn
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref FredApiKeyArn
        - Statement:
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:fii-signal-engine-${Stage}

  FeedCompilerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-feed-compiler-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/feed_compiler/
      Description: Compiles daily feed from signals
      Events:
        DailyFeedCompile:
          Type: Schedule
          Properties:
            Schedule: cron(30 11 ? * MON-FRI *)
            Description: Compile feed at 6:30AM ET weekdays
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - S3CrudPolicy:
            BucketName: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]

  # NOTE: StrategyEngineFunction requires scipy for portfolio optimization (Prompt 5).
  # scipy will be added as a separate layer when that feature is implemented.
  StrategyEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-strategy-engine-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/strategy_engine/
      Description: Sharpe optimization and Monte Carlo simulation
      Timeout: 300
      MemorySize: 2048
      Events:
        Optimize:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /strategy/{proxy+}
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - S3CrudPolicy:
            BucketName: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]

  DataRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub fii-data-refresh-${Stage}
      Handler: handler.lambda_handler
      CodeUri: functions/data_refresh/
      Description: Scheduled price & technical data refresh via Finnhub
      Timeout: 900
      MemorySize: 1024
      Events:
        MarketHoursRefresh:
          Type: Schedule
          Properties:
            Schedule: cron(0/30 14-21 ? * MON-FRI *)
            Description: Refresh prices every 30 min during market hours (9:30AM-4PM ET)
            Enabled: true
            Input: '{"mode": "prices"}'
        DailyTechnicalsRefresh:
          Type: Schedule
          Properties:
            Schedule: cron(0 22 ? * MON-FRI *)
            Description: Refresh technicals daily after market close (5PM ET)
            Enabled: true
            Input: '{"mode": "full"}'
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
        - S3CrudPolicy:
            BucketName: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]

Conditions:
  HasAppleConfig: !Not [!Equals [!Ref AppleTeamId, '']]
  CreateTable: !Equals [!Ref ExistingTableName, '']
  CreateBucket: !Equals [!Ref ExistingBucketName, '']

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
  TableName:
    Description: DynamoDB Table Name
    Value: !If [CreateTable, !Ref FiiTable, !Ref ExistingTableName]
  BucketName:
    Description: S3 Data Bucket Name
    Value: !If [CreateBucket, !Ref FiiDataBucket, !Ref ExistingBucketName]
  EventAlertsTopicArn:
    Description: SNS Topic ARN for event alerts
    Value: !Ref EventAlertsTopic
